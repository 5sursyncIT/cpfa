# Workflow d'Abonnement Biblioth√®que CPFA
## Guide complet du processus de validation manuelle (paiement hors ligne)

**Version:** 1.0.0
**Date:** 2025-10-10
**Mode de paiement:** Hors ligne avec QR codes statiques Wave et Orange Money

---

## Table des mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Pr√©requis techniques](#pr√©requis-techniques)
3. [Workflow c√¥t√© utilisateur](#workflow-c√¥t√©-utilisateur)
4. [Workflow c√¥t√© admin](#workflow-c√¥t√©-admin)
5. [Statuts et transitions](#statuts-et-transitions)
6. [Templates d'emails](#templates-demails)
7. [Int√©grations plugins](#int√©grations-plugins)
8. [Sc√©narios d'erreur](#sc√©narios-derreur)
9. [Configuration initiale](#configuration-initiale)
10. [Diagrammes de flux](#diagrammes-de-flux)

---

## Vue d'ensemble

Le syst√®me d'abonnement biblioth√®que CPFA fonctionne en **mode hors ligne** : les utilisateurs effectuent leur paiement via Wave ou Orange Money en scannant un QR code statique, puis un administrateur valide manuellement la pr√©inscription apr√®s avoir v√©rifi√© la r√©ception du paiement.

### Principes fondamentaux

- **Aucun webhook automatique** : pas d'int√©gration API avec Wave/Orange Money
- **Validation manuelle obligatoire** : un humain v√©rifie chaque paiement
- **QR codes statiques** : configur√©s une seule fois dans WordPress
- **Tra√ßabilit√© compl√®te** : chaque action est enregistr√©e avec timestamp et auteur
- **G√©n√©ration automatique de carte** : d√®s validation, le PDF est cr√©√© et envoy√©

### Types d'abonnements

| Type | Prix | Caution | Total | Dur√©e |
|------|------|---------|-------|-------|
| **√âtudiant** | 10 000 FCFA | - | 10 000 FCFA | 1 an |
| **Professionnel** | 15 000 FCFA | - | 15 000 FCFA | 1 an |
| **Emprunt domicile** | 15 000 FCFA | 35 000 FCFA | 50 000 FCFA | 1 an |

**Note** : La caution de 35 000 FCFA pour l'emprunt domicile est remboursable si le livre est retourn√© en bon √©tat.

---

## Pr√©requis techniques

### Plugin 1: CPFA Core Manager

- ‚úÖ **CPT `cpfa_abonnement`** avec meta boxes :
  - `_cpfa_abonnement_nom` (text)
  - `_cpfa_abonnement_prenom` (text)
  - `_cpfa_abonnement_email` (email)
  - `_cpfa_abonnement_telephone` (text)
  - `_cpfa_abonnement_type` (select: etudiant, professionnel, emprunt_domicile)
  - `_cpfa_abonnement_photo` (file upload)
  - `_cpfa_abonnement_cni` (file upload)
  - `_cpfa_abonnement_statut` (select: awaiting_validation, active, rejected, expired, suspended, ended)
  - `_cpfa_abonnement_montant` (number)
  - `_cpfa_abonnement_date_debut` (date)
  - `_cpfa_abonnement_date_fin` (date)
  - `_cpfa_abonnement_transaction_ref` (text)
  - `_cpfa_abonnement_gateway` (text: wave, orange_money)
  - `_cpfa_abonnement_motif_rejet` (textarea)
  - `_cpfa_abonnement_numero_carte` (text auto-g√©n√©r√©)

- ‚úÖ **Service QR Code** : `Cpfa\Core\Services\QR_Service`
- ‚úÖ **Service Notifications** : `Cpfa\Core\Services\Notification_Service`

### Plugin 2: CPFA Forms & Registrations

- üîÑ **Formulaire d'abonnement** (Gravity Forms ou Forminator)
- üîÑ **Page admin : Pr√©inscriptions en attente**
- üîÑ **AJAX handlers** : validation, rejet, demande justificatif
- üîÑ **Templates emails** : 5 templates HTML

### Plugin 3: CPFA PDF Generator

- üîÑ **Template carte membre** : 85.6 √ó 54mm, recto/verso
- üîÑ **Hook** : √©coute `cpfa_abonnement_validated` pour g√©n√©rer PDF
- üîÑ **Storage** : `wp-content/uploads/cpfa-pdf/{ann√©e}/{mois}/carte-{ID}.pdf`

---

## Workflow c√¥t√© utilisateur

### √âtape 1 : Acc√®s au formulaire

L'utilisateur acc√®de √† la page **Abonnement Biblioth√®que** (exemple : `/abonnement-bibliotheque/`)

**√âl√©ments affich√©s** :
- Titre : "S'abonner √† la biblioth√®que CPFA"
- Description des types d'abonnements et tarifs
- Formulaire d'inscription

### √âtape 2 : Remplissage du formulaire

**Champs obligatoires** :
- Nom
- Pr√©nom
- Email
- T√©l√©phone
- Type d'abonnement (radio: √âtudiant / Professionnel / Emprunt domicile)
- Upload photo d'identit√© (JPG/PNG, max 2MB)
- Upload CNI/passeport (PDF/JPG, max 5MB)
- ‚òë J'accepte les conditions d'utilisation
- ‚òë Je consens au traitement de mes donn√©es (RGPD)

**Validation c√¥t√© client** :
- Format email correct
- T√©l√©phone au format international (+221...)
- Fichiers dans les formats et tailles autoris√©s

### √âtape 3 : Affichage des options de paiement

D√®s que l'utilisateur s√©lectionne un type d'abonnement, le montant s'affiche dynamiquement.

**Interface de paiement** :
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí∞ MONTANT √Ä PAYER : 15 000 FCFA                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ Choisissez votre m√©thode de paiement :                     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  üì± WAVE           ‚îÇ    ‚îÇ  üß° ORANGE MONEY   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ [QR CODE]‚îÇ      ‚îÇ    ‚îÇ  ‚îÇ [QR CODE]‚îÇ      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  +221 77 123 45 67 ‚îÇ    ‚îÇ  +221 70 987 65 43 ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  CPFA Biblioth√®que ‚îÇ    ‚îÇ  CPFA Biblioth√®que ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  INSTRUCTIONS :                                             ‚îÇ
‚îÇ  1. Scannez le QR code avec votre application mobile       ‚îÇ
‚îÇ  2. Saisissez le montant : 15 000 FCFA                     ‚îÇ
‚îÇ  3. Confirmez le paiement                                   ‚îÇ
‚îÇ  4. Notez la r√©f√©rence de transaction (optionnel)          ‚îÇ
‚îÇ  5. Cliquez sur "Soumettre ma demande" ci-dessous          ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  R√©f√©rence de transaction (optionnel) : [_______________]  ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  [ Soumettre ma demande ]                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### √âtape 4 : Soumission du formulaire

Apr√®s avoir cliqu√© sur "Soumettre ma demande" :

1. **Validation serveur** (Plugin 2) :
   - V√©rification du nonce
   - Sanitization de tous les champs
   - V√©rification MIME types des fichiers
   - V√©rification des doublons (email existant)

2. **Cr√©ation de la pr√©inscription** :
   ```php
   $abonnement_id = wp_insert_post([
       'post_type'   => 'cpfa_abonnement',
       'post_title'  => sanitize_text_field($_POST['prenom'] . ' ' . $_POST['nom']),
       'post_status' => 'publish'
   ]);

   update_post_meta($abonnement_id, '_cpfa_abonnement_nom', sanitize_text_field($_POST['nom']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_prenom', sanitize_text_field($_POST['prenom']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_email', sanitize_email($_POST['email']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_telephone', sanitize_text_field($_POST['telephone']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_type', sanitize_key($_POST['type']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_statut', 'awaiting_validation');
   update_post_meta($abonnement_id, '_cpfa_abonnement_montant', intval($_POST['montant']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_transaction_ref', sanitize_text_field($_POST['transaction_ref']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_gateway', sanitize_key($_POST['gateway']));
   update_post_meta($abonnement_id, '_cpfa_abonnement_numero_preinscription', 'PRE-' . date('Ymd') . '-' . str_pad($abonnement_id, 5, '0', STR_PAD_LEFT));

   // Upload des fichiers
   $photo_id = media_handle_upload('photo', $abonnement_id);
   update_post_meta($abonnement_id, '_cpfa_abonnement_photo', $photo_id);

   $cni_id = media_handle_upload('cni', $abonnement_id);
   update_post_meta($abonnement_id, '_cpfa_abonnement_cni', $cni_id);
   ```

3. **Envoi des emails** :
   - Email √† l'utilisateur : "Pr√©inscription re√ßue"
   - Email √† l'admin : "Nouvelle pr√©inscription √† valider"

4. **Message de confirmation** :
   ```
   ‚úÖ Votre demande a bien √©t√© enregistr√©e !

   Num√©ro de pr√©inscription : PRE-20251010-00042

   Vous allez recevoir un email de confirmation √† l'adresse : user@example.com

   Votre abonnement sera activ√© sous 24-48h ouvr√©es apr√®s v√©rification de votre paiement.

   Vous recevrez votre carte membre par email d√®s validation.
   ```

### √âtape 5 : Attente de validation

L'utilisateur re√ßoit l'**Email 1 : Pr√©inscription re√ßue** dans sa bo√Æte mail.

**Ce qu'il peut faire** :
- V√©rifier ses spams si email non re√ßu
- R√©pondre √† l'email avec la r√©f√©rence de transaction si demand√©e
- Contacter l'admin pour toute question

**D√©lai d'attente** : 24-48h ouvr√©es (configurable)

### √âtape 6a : Validation (sc√©nario positif)

L'utilisateur re√ßoit l'**Email 3 : Abonnement valid√©** avec :
- Confirmation d'activation
- Num√©ro de carte membre
- Dates de validit√©
- **Carte membre PDF en pi√®ce jointe** (avec QR code)
- Lien de t√©l√©chargement s√©curis√©

**Actions possibles** :
- T√©l√©charger et imprimer la carte
- Sauvegarder le PDF sur son t√©l√©phone
- Se rendre √† la biblioth√®que avec la carte (papier ou mobile)

### √âtape 6b : Rejet (sc√©nario n√©gatif)

L'utilisateur re√ßoit l'**Email 4 : Pr√©inscription rejet√©e** avec :
- Motif du rejet (paiement non re√ßu, montant incorrect, photo illisible, etc.)
- D√©tails additionnels
- Instructions pour r√©gulariser
- Contact de l'admin

**Actions possibles** :
- Fournir un justificatif de paiement
- Soumettre une nouvelle demande avec les corrections

---

## Workflow c√¥t√© admin

### √âtape 1 : R√©ception de la notification

L'administrateur re√ßoit un **Email 2 : Nouvelle pr√©inscription √† valider** contenant :
- Nom, pr√©nom, type, montant
- Email et t√©l√©phone du demandeur
- **Lien direct** vers la page de validation dans WordPress

### √âtape 2 : Acc√®s √† l'interface de validation

L'admin se connecte √† WordPress et acc√®de √† **CPFA > Pr√©inscriptions en attente**

**Interface liste** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CPFA - Pr√©inscriptions en attente                                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                              ‚îÇ
‚îÇ  Filtres : [Tous types ‚ñº]  [Tous statuts ‚ñº]  [Rechercher...]  [Filtrer]   ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ #  ‚îÇ Nom          ‚îÇ Type        ‚îÇ Montant‚îÇ Date       ‚îÇ Actions     ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ 42 ‚îÇ Jean Dupont  ‚îÇ Pro         ‚îÇ 15,000 ‚îÇ 10/10/2025 ‚îÇ üëÅÔ∏è ‚úÖ ‚ùå üîÑ ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ jean@mail.sn ‚îÇ             ‚îÇ FCFA   ‚îÇ 14:32      ‚îÇ             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ +221771234567‚îÇ             ‚îÇ        ‚îÇ üü° En att. ‚îÇ             ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ 41 ‚îÇ Fatou Sow    ‚îÇ √âtudiant    ‚îÇ 10,000 ‚îÇ 09/10/2025 ‚îÇ üëÅÔ∏è ‚úÖ ‚ùå üîÑ ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ fatou@etu.sn ‚îÇ             ‚îÇ FCFA   ‚îÇ 09:15      ‚îÇ             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ +221769876543‚îÇ             ‚îÇ        ‚îÇ üü° En att. ‚îÇ             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îÇ  L√©gende : üëÅÔ∏è Voir d√©tails | ‚úÖ Valider | ‚ùå Rejeter | üîÑ Demander justif. ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### √âtape 3a : Consulter les d√©tails (clic sur üëÅÔ∏è)

**Modal "D√©tails de la pr√©inscription"** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ D√©tails de la pr√©inscription #PRE-20251010-00042               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ INFORMATIONS PERSONNELLES                                       ‚îÇ
‚îÇ Nom complet : Jean Dupont                                       ‚îÇ
‚îÇ Email       : jean@mail.sn                                      ‚îÇ
‚îÇ T√©l√©phone   : +221 77 123 45 67                                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ ABONNEMENT                                                      ‚îÇ
‚îÇ Type        : Professionnel                                     ‚îÇ
‚îÇ Montant     : 15 000 FCFA                                       ‚îÇ
‚îÇ Date demande: 10/10/2025 √† 14:32                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ PAIEMENT                                                        ‚îÇ
‚îÇ Gateway     : Wave                                              ‚îÇ
‚îÇ R√©f. fournie: (aucune)                                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ PI√àCES JOINTES                                                  ‚îÇ
‚îÇ Photo       : [Voir] [T√©l√©charger]                             ‚îÇ
‚îÇ               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                      ‚îÇ
‚îÇ               ‚îÇ  [Photo] ‚îÇ                                      ‚îÇ
‚îÇ               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ CNI         : [Voir PDF] [T√©l√©charger]                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ HISTORIQUE                                                      ‚îÇ
‚îÇ ‚Ä¢ 10/10/2025 14:32 - Pr√©inscription cr√©√©e                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ [Fermer]  [Valider]  [Rejeter]  [Demander justificatif]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### √âtape 3b : V√©rifier le paiement (hors WordPress)

L'admin ouvre son **application Wave** ou **Orange Money** sur son t√©l√©phone ou son interface web :

1. Consulte l'historique des transactions
2. Cherche un paiement de **15 000 FCFA** le **10/10/2025** vers **14:30-14:35**
3. V√©rifie l'exp√©diteur (nom ou num√©ro correspondant √† Jean Dupont / +221771234567)
4. Note la **r√©f√©rence de transaction** (ex: `WAV-20251010-ABCD1234`)

**Sc√©nario 1 : Paiement trouv√©** ‚Üí Passer √† l'√©tape 4a (Validation)
**Sc√©nario 2 : Paiement non trouv√©** ‚Üí Passer √† l'√©tape 4b (Demande justificatif) ou 4c (Rejet)

### √âtape 4a : Validation (clic sur ‚úÖ)

**Modal "Valider la pr√©inscription"** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Valider la pr√©inscription               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Nom: Jean Dupont                        ‚îÇ
‚îÇ Type: Professionnel (15,000 FCFA)      ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ R√©f√©rence de transaction: [WAV-20251010-ABCD1234] ‚îÇ
‚îÇ Gateway: ‚óã Wave  ‚óè Orange Money        ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Date de d√©but: [11/10/2025]            ‚îÇ
‚îÇ Date de fin:   [11/10/2026]            ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚òë G√©n√©rer la carte membre              ‚îÇ
‚îÇ ‚òë Envoyer email avec carte             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Annuler]  [Valider l'abonnement]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Actions d√©clench√©es par le clic sur "Valider l'abonnement"** :

```php
// 1. Mise √† jour du statut
update_post_meta($abonnement_id, '_cpfa_abonnement_statut', 'active');
update_post_meta($abonnement_id, '_cpfa_abonnement_transaction_ref', sanitize_text_field($_POST['transaction_ref']));
update_post_meta($abonnement_id, '_cpfa_abonnement_gateway', sanitize_key($_POST['gateway']));
update_post_meta($abonnement_id, '_cpfa_abonnement_date_debut', sanitize_text_field($_POST['date_debut']));
update_post_meta($abonnement_id, '_cpfa_abonnement_date_fin', sanitize_text_field($_POST['date_fin']));
update_post_meta($abonnement_id, '_cpfa_abonnement_valide_par', get_current_user_id());
update_post_meta($abonnement_id, '_cpfa_abonnement_valide_le', current_time('mysql'));

// 2. G√©n√©ration du num√©ro de carte
$numero_carte = 'CPFA-' . date('Y') . '-' . str_pad($abonnement_id, 6, '0', STR_PAD_LEFT);
update_post_meta($abonnement_id, '_cpfa_abonnement_numero_carte', $numero_carte);

// 3. Hook pour g√©n√©rer le PDF (Plugin 3 √©coute cet hook)
do_action('cpfa_abonnement_validated', $abonnement_id);

// 4. Envoi de l'email avec PDF en pi√®ce jointe
$carte_pdf_path = get_post_meta($abonnement_id, '_cpfa_carte_pdf', true);
Cpfa\Forms\Notification_Service::send_abonnement_valide_email($abonnement_id, $carte_pdf_path);

// 5. Log dans l'historique
$history = get_post_meta($abonnement_id, '_cpfa_abonnement_historique', true) ?: [];
$history[] = [
    'date'   => current_time('mysql'),
    'action' => 'validated',
    'user'   => get_current_user_id(),
    'data'   => [
        'transaction_ref' => sanitize_text_field($_POST['transaction_ref']),
        'gateway'         => sanitize_key($_POST['gateway'])
    ]
];
update_post_meta($abonnement_id, '_cpfa_abonnement_historique', $history);
```

**Message de succ√®s** :
```
‚úÖ Abonnement valid√© avec succ√®s !

Carte membre g√©n√©r√©e : CPFA-2025-000042
Email envoy√© √† : jean@mail.sn

[Voir la carte] [Fermer]
```

### √âtape 4b : Demande de justificatif (clic sur üîÑ)

Si le paiement n'est pas trouv√© mais que l'admin veut laisser une chance √† l'utilisateur :

**Modal "Demander un justificatif"** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Demander un justificatif de paiement   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Nom: Jean Dupont (jean@mail.sn)        ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Un email sera envoy√© pour demander :   ‚îÇ
‚îÇ ‚Ä¢ Capture d'√©cran de la transaction     ‚îÇ
‚îÇ ‚Ä¢ R√©f√©rence de transaction              ‚îÇ
‚îÇ ‚Ä¢ Date et heure du paiement             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Message personnalis√© (optionnel) :     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Nous n'avons pas trouv√© votre       ‚îÇ ‚îÇ
‚îÇ ‚îÇ paiement dans notre historique.     ‚îÇ ‚îÇ
‚îÇ ‚îÇ Merci de nous transmettre...        ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Annuler]  [Envoyer la demande]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Actions d√©clench√©es** :
- Envoi de l'**Email 5 : Justificatif de paiement demand√©**
- Ajout d'une note dans l'historique
- Statut reste `awaiting_validation`

### √âtape 4c : Rejet (clic sur ‚ùå)

Si le paiement n'est vraiment pas trouv√© ou si le dossier est incomplet :

**Modal "Rejeter la pr√©inscription"** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Rejeter la pr√©inscription               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Nom: Jean Dupont                        ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Motif du rejet:                         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ ‚óã Paiement non re√ßu                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚óã Montant incorrect                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚óã Photo illisible                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚óã Informations incompl√®tes          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚óè Autre (pr√©ciser ci-dessous)       ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ D√©tails: [____________________________] ‚îÇ
‚îÇ [Aucun paiement correspondant trouv√©   ‚îÇ
‚îÇ  dans l'historique Wave du 10/10]      ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚òë Envoyer email √† l'utilisateur         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Annuler]  [Confirmer le rejet]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Actions d√©clench√©es** :

```php
// 1. Mise √† jour du statut
update_post_meta($abonnement_id, '_cpfa_abonnement_statut', 'rejected');
update_post_meta($abonnement_id, '_cpfa_abonnement_motif_rejet', sanitize_text_field($_POST['motif']));
update_post_meta($abonnement_id, '_cpfa_abonnement_details_rejet', sanitize_textarea_field($_POST['details']));
update_post_meta($abonnement_id, '_cpfa_abonnement_rejete_par', get_current_user_id());
update_post_meta($abonnement_id, '_cpfa_abonnement_rejete_le', current_time('mysql'));

// 2. Envoi de l'email
Cpfa\Forms\Notification_Service::send_abonnement_rejete_email($abonnement_id);

// 3. Log dans l'historique
$history = get_post_meta($abonnement_id, '_cpfa_abonnement_historique', true) ?: [];
$history[] = [
    'date'   => current_time('mysql'),
    'action' => 'rejected',
    'user'   => get_current_user_id(),
    'data'   => [
        'motif'   => sanitize_text_field($_POST['motif']),
        'details' => sanitize_textarea_field($_POST['details'])
    ]
];
update_post_meta($abonnement_id, '_cpfa_abonnement_historique', $history);
```

**Message de confirmation** :
```
‚úÖ Pr√©inscription rejet√©e

Email envoy√© √† : jean@mail.sn
Motif : Paiement non re√ßu

[Fermer]
```

---

## Statuts et transitions

### Diagramme d'√©tats

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ FORMULAIRE SOUMIS     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ awaiting_validation   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
            ‚îÇ                   ‚îÇ                     ‚îÇ
            ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
            ‚îÇ      ‚îÇ            ‚îÇ            ‚îÇ        ‚îÇ
            ‚îÇ      ‚ñº            ‚ñº            ‚ñº        ‚îÇ
            ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
            ‚îÇ  ‚îÇrejected‚îÇ  ‚îÇ active ‚îÇ  ‚îÇ expired ‚îÇ   ‚îÇ
            ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
            ‚îÇ                  ‚îÇ                      ‚îÇ
            ‚îÇ                  ‚ñº                      ‚îÇ
            ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
            ‚îÇ            ‚îÇ suspended ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      (p√©nalit√©s pay√©es)
            ‚îÇ                  ‚îÇ
            ‚îÇ                  ‚ñº
            ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   ended   ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Description des statuts

| Statut | Description | Actions possibles |
|--------|-------------|-------------------|
| **awaiting_validation** | Pr√©inscription en attente de v√©rification par l'admin | Valider, Rejeter, Demander justificatif |
| **active** | Abonnement valid√© et actif, carte g√©n√©r√©e | Suspendre, Prolonger, R√©imprimer carte |
| **rejected** | Pr√©inscription rejet√©e (paiement non confirm√©, dossier incomplet) | Archiver, Supprimer |
| **expired** | Pr√©inscription non valid√©e dans le d√©lai (7 jours par d√©faut) | R√©activer, Supprimer |
| **suspended** | Abonnement suspendu (ex: p√©nalit√©s impay√©es) | R√©activer (apr√®s paiement p√©nalit√©s) |
| **ended** | P√©riode d'abonnement termin√©e | Renouveler (cr√©er nouvel abonnement) |

### R√®gles de transition

- `awaiting_validation` ‚Üí `active` : Admin valide + paiement v√©rifi√©
- `awaiting_validation` ‚Üí `rejected` : Admin rejette (paiement non trouv√©, dossier incomplet)
- `awaiting_validation` ‚Üí `expired` : Cron automatique apr√®s 7 jours sans action admin
- `active` ‚Üí `suspended` : P√©nalit√©s d'emprunt impay√©es
- `active` ‚Üí `ended` : Date de fin atteinte (cron automatique)
- `suspended` ‚Üí `active` : Paiement des p√©nalit√©s confirm√©
- `rejected` ‚Üí `awaiting_validation` : R√©activation manuelle par admin (rare)

---

## Templates d'emails

Voir [cahier_des_charges.md - Templates d'emails](cahier_des_charges.md#templates-demails-pour-le-workflow-dabonnement-paiement-hors-ligne) pour le contenu complet des 5 templates.

### R√©capitulatif

| Email | Destinataire | D√©clencheur | Pi√®ce jointe |
|-------|--------------|-------------|--------------|
| **1. Pr√©inscription re√ßue** | Utilisateur | Soumission formulaire | - |
| **2. Nouvelle pr√©inscription** | Admin | Soumission formulaire | - |
| **3. Abonnement valid√©** | Utilisateur | Admin valide | Carte membre PDF |
| **4. Pr√©inscription rejet√©e** | Utilisateur | Admin rejette | - |
| **5. Justificatif demand√©** | Utilisateur | Admin clique "Demander justificatif" | - |

---

## Int√©grations plugins

### Plugin 1 : CPFA Core Manager

**Responsabilit√©s** :
- Fournir le CPT `cpfa_abonnement` avec toutes les meta boxes
- Fournir les services partag√©s (QR, Notifications)
- Exposer les hooks pour la g√©n√©ration PDF

**Hook √† √©couter** : Aucun (le Core fournit seulement)

**Hook √† d√©clencher** :
```php
// D√©clench√© par Plugin 2 lors de la validation
do_action('cpfa_abonnement_validated', $abonnement_id);
```

### Plugin 2 : CPFA Forms & Registrations

**Responsabilit√©s** :
- Cr√©er et g√©rer le formulaire d'abonnement (Gravity Forms/Forminator)
- Cr√©er la page admin "Pr√©inscriptions en attente"
- G√©rer les actions AJAX (valider, rejeter, demander justificatif)
- Envoyer tous les emails
- D√©clencher le hook de g√©n√©ration PDF

**Hooks √† d√©clencher** :
```php
// Lors de la validation par l'admin
do_action('cpfa_abonnement_validated', $abonnement_id);

// Lors du rejet
do_action('cpfa_abonnement_rejected', $abonnement_id, $motif, $details);

// Lors de la soumission
do_action('cpfa_abonnement_submitted', $abonnement_id);
```

**Hooks √† √©couter** :
```php
// √âcouter la g√©n√©ration de PDF (Plugin 3 notifie quand c'est fait)
add_action('cpfa_carte_generated', 'cpfa_forms_send_carte_email', 10, 2);
function cpfa_forms_send_carte_email($abonnement_id, $pdf_path) {
    // Envoyer l'email avec le PDF en pi√®ce jointe
}
```

### Plugin 3 : CPFA PDF Generator

**Responsabilit√©s** :
- √âcouter le hook `cpfa_abonnement_validated`
- G√©n√©rer la carte membre PDF (85.6 √ó 54mm)
- Stocker le PDF dans `wp-content/uploads/cpfa-pdf/{ann√©e}/{mois}/`
- Notifier Plugin 2 que la g√©n√©ration est termin√©e

**Hooks √† √©couter** :
```php
add_action('cpfa_abonnement_validated', 'cpfa_pdf_generate_carte_membre', 10, 1);
function cpfa_pdf_generate_carte_membre($abonnement_id) {
    // 1. R√©cup√©rer les donn√©es de l'abonnement
    $nom = get_post_meta($abonnement_id, '_cpfa_abonnement_nom', true);
    $prenom = get_post_meta($abonnement_id, '_cpfa_abonnement_prenom', true);
    $numero_carte = get_post_meta($abonnement_id, '_cpfa_abonnement_numero_carte', true);
    $date_fin = get_post_meta($abonnement_id, '_cpfa_abonnement_date_fin', true);
    $photo_id = get_post_meta($abonnement_id, '_cpfa_abonnement_photo', true);

    // 2. G√©n√©rer le QR code de v√©rification
    $token = Cpfa\Core\Services\QR_Service::generate_token($abonnement_id, 'abonnement');
    $verify_url = site_url('/verif/' . $token);
    $qr_png = Cpfa\Core\Services\QR_Service::generate_png($verify_url);

    // 3. Rendre le template HTML
    $html = cpfa_render_template('cards/member-card.php', [
        'nom'          => $nom,
        'prenom'       => $prenom,
        'numero_carte' => $numero_carte,
        'date_fin'     => $date_fin,
        'photo_url'    => wp_get_attachment_url($photo_id),
        'qr_code'      => $qr_png
    ]);

    // 4. G√©n√©rer le PDF avec mPDF
    $mpdf = new \Mpdf\Mpdf([
        'format' => [85.6, 54], // Format carte bancaire
        'margin_left'   => 0,
        'margin_right'  => 0,
        'margin_top'    => 0,
        'margin_bottom' => 0
    ]);
    $mpdf->WriteHTML($html);

    // 5. Sauvegarder le PDF
    $upload_dir = wp_upload_dir();
    $pdf_dir = $upload_dir['basedir'] . '/cpfa-pdf/' . date('Y') . '/' . date('m');
    wp_mkdir_p($pdf_dir);

    $pdf_filename = 'carte-' . $abonnement_id . '.pdf';
    $pdf_path = $pdf_dir . '/' . $pdf_filename;
    $mpdf->Output($pdf_path, 'F');

    // 6. Stocker le chemin en post meta
    update_post_meta($abonnement_id, '_cpfa_carte_pdf', $pdf_path);
    update_post_meta($abonnement_id, '_cpfa_carte_pdf_url', $upload_dir['baseurl'] . '/cpfa-pdf/' . date('Y') . '/' . date('m') . '/' . $pdf_filename);

    // 7. Notifier Plugin 2 que c'est termin√©
    do_action('cpfa_carte_generated', $abonnement_id, $pdf_path);
}
```

**Hooks √† d√©clencher** :
```php
// Quand la carte est g√©n√©r√©e et sauvegard√©e
do_action('cpfa_carte_generated', $abonnement_id, $pdf_path);
```

---

## Sc√©narios d'erreur

### Sc√©nario 1 : Doublons (m√™me email)

**Probl√®me** : Un utilisateur soumet plusieurs fois le formulaire avec le m√™me email.

**Solution** :
```php
// Lors de la soumission, v√©rifier les doublons
$existing = get_posts([
    'post_type'  => 'cpfa_abonnement',
    'meta_query' => [
        [
            'key'   => '_cpfa_abonnement_email',
            'value' => sanitize_email($_POST['email'])
        ],
        [
            'key'   => '_cpfa_abonnement_statut',
            'value' => ['awaiting_validation', 'active'],
            'compare' => 'IN'
        ]
    ]
]);

if (!empty($existing)) {
    wp_send_json_error([
        'message' => 'Vous avez d√©j√† une demande en cours avec cet email. Num√©ro : ' . get_post_meta($existing[0]->ID, '_cpfa_abonnement_numero_preinscription', true)
    ]);
}
```

### Sc√©nario 2 : Fichier upload√© corrompu/illisible

**Probl√®me** : La photo ou la CNI est floue, corrompue, ou ne s'ouvre pas.

**Solution** :
- Admin clique sur "Demander justificatif" avec message personnalis√© : "Votre photo d'identit√© est illisible, merci de la soumettre √† nouveau"
- Ou admin rejette directement avec motif "Photo illisible"

### Sc√©nario 3 : Paiement effectu√© mais pas trouv√© par l'admin

**Probl√®me** : L'utilisateur a pay√© mais l'admin ne trouve pas la transaction.

**Solution** :
1. Admin clique sur "Demander justificatif"
2. Utilisateur r√©pond √† l'email avec capture d'√©cran
3. Admin v√©rifie √† nouveau son interface mobile money avec les infos fournies
4. Si confirm√© : validation manuelle + saisie de la r√©f√©rence

### Sc√©nario 4 : Montant incorrect pay√©

**Probl√®me** : L'utilisateur paie 10 000 FCFA au lieu de 15 000 FCFA.

**Solution** :
- Admin rejette avec motif "Montant incorrect"
- Email de rejet pr√©cise : "Vous avez pay√© 10 000 FCFA au lieu de 15 000 FCFA. Merci d'effectuer un paiement compl√©mentaire de 5 000 FCFA."
- Utilisateur peut soumettre une nouvelle demande apr√®s paiement compl√©mentaire

### Sc√©nario 5 : Expiration automatique (pas d'action admin sous 7 jours)

**Probl√®me** : L'admin ne traite pas la pr√©inscription dans le d√©lai.

**Solution** :
- Cron job quotidien v√©rifie les pr√©inscriptions `awaiting_validation` cr√©√©es il y a plus de 7 jours
- Passe automatiquement en statut `expired`
- Envoie un email √† l'utilisateur : "Votre pr√©inscription a expir√© faute de validation. Vous pouvez soumettre une nouvelle demande."

```php
add_action('cpfa_daily', 'cpfa_expire_old_preinscriptions');
function cpfa_expire_old_preinscriptions() {
    $expire_after_days = get_option('cpfa_preinscription_expire_days', 7);
    $date_limite = date('Y-m-d H:i:s', strtotime('-' . $expire_after_days . ' days'));

    $old_preinscriptions = get_posts([
        'post_type'      => 'cpfa_abonnement',
        'date_query'     => [
            ['before' => $date_limite]
        ],
        'meta_query'     => [
            [
                'key'   => '_cpfa_abonnement_statut',
                'value' => 'awaiting_validation'
            ]
        ],
        'posts_per_page' => -1
    ]);

    foreach ($old_preinscriptions as $preinscription) {
        update_post_meta($preinscription->ID, '_cpfa_abonnement_statut', 'expired');
        Cpfa\Forms\Notification_Service::send_preinscription_expired_email($preinscription->ID);
    }
}
```

### Sc√©nario 6 : G√©n√©ration PDF √©choue

**Probl√®me** : mPDF rencontre une erreur (manque de m√©moire, police manquante, etc.)

**Solution** :
```php
try {
    $mpdf = new \Mpdf\Mpdf(['format' => [85.6, 54]]);
    $mpdf->WriteHTML($html);
    $mpdf->Output($pdf_path, 'F');

    update_post_meta($abonnement_id, '_cpfa_carte_pdf', $pdf_path);
    do_action('cpfa_carte_generated', $abonnement_id, $pdf_path);

} catch (\Mpdf\MpdfException $e) {
    // Logger l'erreur
    error_log('CPFA PDF Generation Error: ' . $e->getMessage());

    // Notifier l'admin
    wp_mail(
        get_option('admin_email'),
        '[CPFA] Erreur g√©n√©ration carte membre',
        'La g√©n√©ration de la carte pour l\'abonnement #' . $abonnement_id . ' a √©chou√©. Erreur : ' . $e->getMessage()
    );

    // Ne pas envoyer l'email √† l'utilisateur, marquer pour retry
    update_post_meta($abonnement_id, '_cpfa_carte_generation_failed', true);
}
```

---

## Configuration initiale

### √âtape 1 : Activer les 3 plugins

```bash
# Via WP-CLI
wp plugin activate cpfa-core-manager cpfa-forms-registrations cpfa-pdf-generator

# Ou via l'interface WordPress : Extensions > Plugins install√©s > Activer
```

### √âtape 2 : Configurer les QR codes statiques

1. Aller dans **CPFA > R√©glages > Paiements**
2. **Section "QR Code Wave"** :
   - Cliquer sur "T√©l√©verser QR Wave"
   - S√©lectionner l'image du QR code Wave (fournie par Wave apr√®s cr√©ation du compte marchand)
   - Saisir le num√©ro Wave : `+221 77 123 45 67`
   - Saisir le nom du compte : `CPFA - Centre de Formation`
3. **Section "QR Code Orange Money"** :
   - Cliquer sur "T√©l√©verser QR Orange Money"
   - S√©lectionner l'image du QR code Orange Money
   - Saisir le num√©ro : `+221 70 987 65 43`
   - Saisir le nom du compte : `CPFA - Centre de Formation`
4. Personnaliser les instructions si n√©cessaire
5. D√©finir le d√©lai d'expiration (par d√©faut : 7 jours)
6. Cliquer sur **Enregistrer les modifications**

### √âtape 3 : Configurer les emails

1. Aller dans **CPFA > R√©glages > Notifications**
2. Saisir l'email de l'administrateur qui recevra les notifications : `admin@cpfa.sn`
3. Personnaliser les templates d'emails si besoin (logo, couleurs, signature)
4. Configurer l'exp√©diteur :
   - Nom : `CPFA Biblioth√®que`
   - Email : `bibliotheque@cpfa.sn`
5. Cliquer sur **Enregistrer**

### √âtape 4 : Cr√©er la page formulaire

1. Cr√©er une nouvelle page : **Pages > Ajouter**
2. Titre : `Abonnement Biblioth√®que`
3. Ajouter le shortcode : `[cpfa_abonnement_form]`
4. Ou utiliser Elementor et ajouter le widget "CPFA Registration Form"
5. Publier la page
6. Slug recommand√© : `/abonnement-bibliotheque/`

### √âtape 5 : Configurer les r√¥les et capacit√©s

```php
// Donner la capability aux admins et au r√¥le cpfa_manager
$admin_role = get_role('administrator');
$admin_role->add_cap('manage_cpfa_biblio');

$manager_role = get_role('cpfa_manager');
if ($manager_role) {
    $manager_role->add_cap('manage_cpfa_biblio');
    $manager_role->add_cap('edit_cpfa_abonnements');
    $manager_role->add_cap('validate_cpfa_abonnements');
}
```

### √âtape 6 : Tester le workflow complet

1. **Test soumission** :
   - Aller sur `/abonnement-bibliotheque/`
   - Remplir le formulaire avec des donn√©es de test
   - Uploader des fichiers de test
   - Soumettre
   - V√©rifier l'email de confirmation re√ßu

2. **Test validation admin** :
   - Se connecter en tant qu'admin
   - Aller dans **CPFA > Pr√©inscriptions en attente**
   - Cliquer sur üëÅÔ∏è pour voir les d√©tails
   - Cliquer sur ‚úÖ pour valider
   - Saisir une r√©f√©rence de transaction fictive : `TEST-12345`
   - Valider
   - V√©rifier que la carte PDF est g√©n√©r√©e
   - V√©rifier l'email re√ßu avec la carte en pi√®ce jointe

3. **Test rejet** :
   - Cr√©er une autre pr√©inscription
   - Cliquer sur ‚ùå pour rejeter
   - S√©lectionner un motif
   - V√©rifier l'email de rejet

---

## Diagrammes de flux

### Flux complet (vue d'ensemble)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         WORKFLOW ABONNEMENT BIBLIOTH√àQUE                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

UTILISATEUR                           SYST√àME                       ADMIN
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ  1. Acc√®de au formulaire          ‚îÇ                            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ  2. Remplit les champs            ‚îÇ                            ‚îÇ
     ‚îÇ     + upload photo/CNI            ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ  3. S√©lectionne type abonnement   ‚îÇ                            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ  Affiche QR codes          ‚îÇ
     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  + montant                 ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ  4. Scanne QR avec Wave/OM        ‚îÇ                            ‚îÇ
     ‚îÇ     (hors WordPress)              ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ  5. Paie via app mobile           ‚îÇ                            ‚îÇ
     ‚îÇ     (ex: 15,000 FCFA)             ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ  6. Soumet le formulaire          ‚îÇ                            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ  Cr√©e cpfa_abonnement      ‚îÇ
     ‚îÇ                                   ‚îÇ  Statut: awaiting_validation
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  Email 1: Pr√©inscription   ‚îÇ
     ‚îÇ  "Demande enregistr√©e"            ‚îÇ         re√ßue              ‚îÇ
     ‚îÇ  Email de confirmation            ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
     ‚îÇ                                   ‚îÇ  Email 2: Nouvelle         ‚îÇ
     ‚îÇ                                   ‚îÇ  pr√©inscription √† valider  ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                    7. Ouvre email
     ‚îÇ                                   ‚îÇ                    8. Se connecte WP
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                    9. Va dans
     ‚îÇ                                   ‚îÇ                       "Pr√©inscriptions
     ‚îÇ                                   ‚îÇ                        en attente"
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                    10. Clique üëÅÔ∏è
     ‚îÇ                                   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îÇ                                   ‚îÇ  Affiche modal d√©tails     ‚îÇ
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                    11. V√©rifie paiement
     ‚îÇ                                   ‚îÇ                        dans Wave/OM app
     ‚îÇ                                   ‚îÇ                        (hors WP)
     ‚îÇ                                   ‚îÇ                            ‚îÇ
     ‚îÇ                                   ‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                                   ‚îÇ                    ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ              Trouv√©?         Pas trouv√©?
     ‚îÇ                                   ‚îÇ                    ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ                    ‚ñº                ‚ñº
     ‚îÇ                                   ‚îÇ            12a. Clique ‚úÖ    12b. Clique ‚ùå
     ‚îÇ                                   ‚îÇ                 Valider           Rejeter
     ‚îÇ                                   ‚îÇ                    ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                ‚îÇ
     ‚îÇ                                   ‚îÇ  Saisit r√©f. trans ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  WAV-20251010-ABC  ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ                    ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  Update statut:    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îÇ                                   ‚îÇ  ‚Üí active          ‚îÇ  Saisit motif  ‚îÇ
     ‚îÇ                                   ‚îÇ                    ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  Hook: cpfa_       ‚îÇ  Update statut:‚îÇ
     ‚îÇ                                   ‚îÇ  abonnement_       ‚îÇ  ‚Üí rejected    ‚îÇ
     ‚îÇ                                   ‚îÇ  validated         ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ        ‚îÇ           ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ        ‚ñº           ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  Plugin 3 √©coute   ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  ‚Üí G√©n√®re PDF      ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  ‚Üí Carte membre    ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ        ‚îÇ           ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ        ‚ñº           ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  Hook: cpfa_       ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ  carte_generated   ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ        ‚îÇ           ‚îÇ                ‚îÇ
     ‚îÇ                                   ‚îÇ        ‚ñº           ‚îÇ        ‚ñº       ‚îÇ
     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  Email 3:          ‚îÇ   Email 4:    ‚îÇ
     ‚îÇ  Email avec carte PDF             ‚îÇ  Abonnement        ‚îÇ   Pr√©inscription
     ‚îÇ  CPFA-2025-000042.pdf             ‚îÇ  valid√©            ‚îÇ   rejet√©e     ‚îÇ
     ‚îÇ                                   ‚îÇ                    ‚îÇ                ‚îÇ
     ‚ñº                                   ‚ñº                    ‚ñº                ‚ñº
‚úÖ Peut utiliser la biblioth√®que      Workflow termin√©    ‚ùå Doit soumettre  Workflow termin√©
   avec carte membre                                         nouvelle demande
```

### Flux de validation d√©taill√© (c√¥t√© admin)

```
ADMIN OUVRE "PR√âINSCRIPTIONS EN ATTENTE"
              ‚îÇ
              ‚ñº
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ LISTE AFFICH√âE‚îÇ
      ‚îÇ Filtres dispo ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                   ‚îÇ
    ‚ñº                   ‚ñº
CLIQUE üëÅÔ∏è           ACTIONS RAPIDES
Voir d√©tails
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MODAL D√âTAILS                       ‚îÇ
‚îÇ ‚Ä¢ Nom, email, tel                   ‚îÇ
‚îÇ ‚Ä¢ Type, montant                     ‚îÇ
‚îÇ ‚Ä¢ Pi√®ces jointes (photo, CNI)      ‚îÇ
‚îÇ ‚Ä¢ R√©f. transaction si fournie      ‚îÇ
‚îÇ ‚Ä¢ Historique                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ           ‚îÇ
    ‚ñº           ‚ñº
VALIDER      REJETER       DEMANDER JUSTIF.
  ‚úÖ           ‚ùå                üîÑ
    ‚îÇ           ‚îÇ                ‚îÇ
    ‚ñº           ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MODAL ‚îÇ   ‚îÇ MODAL  ‚îÇ     ‚îÇ  MODAL   ‚îÇ
‚îÇ Saisir‚îÇ   ‚îÇS√©lect. ‚îÇ     ‚îÇ Message  ‚îÇ
‚îÇ r√©f.  ‚îÇ   ‚îÇ motif  ‚îÇ     ‚îÇ perso    ‚îÇ
‚îÇtrans. ‚îÇ   ‚îÇ rejet  ‚îÇ     ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ            ‚îÇ                ‚îÇ
    ‚ñº            ‚ñº                ‚ñº
SOUMET       SOUMET           SOUMET
    ‚îÇ            ‚îÇ                ‚îÇ
    ‚ñº            ‚ñº                ‚ñº
UPDATE       UPDATE           EMAIL
statut:      statut:          envoy√©
active       rejected         (justif.)
    ‚îÇ            ‚îÇ                ‚îÇ
    ‚ñº            ‚îÇ                ‚îÇ
HOOK             ‚îÇ                ‚îÇ
cpfa_            ‚îÇ                ‚îÇ
abonnement_      ‚îÇ                ‚îÇ
validated        ‚îÇ                ‚îÇ
    ‚îÇ            ‚îÇ                ‚îÇ
    ‚ñº            ‚îÇ                ‚îÇ
PLUGIN 3         ‚îÇ                ‚îÇ
g√©n√®re           ‚îÇ                ‚îÇ
carte PDF        ‚îÇ                ‚îÇ
    ‚îÇ            ‚îÇ                ‚îÇ
    ‚ñº            ‚ñº                ‚ñº
EMAIL 3      EMAIL 4          Statut reste
(carte)      (rejet)          awaiting_validation
    ‚îÇ            ‚îÇ                ‚îÇ
    ‚ñº            ‚ñº                ‚ñº
  ‚úÖ FIN       ‚ùå FIN          Attente r√©ponse
                                utilisateur
```

---

## Annexes

### A. Checklist de d√©veloppement

#### Plugin 1 : CPFA Core Manager
- [x] CPT `cpfa_abonnement` cr√©√©
- [x] Meta boxes pour tous les champs
- [x] Service QR_Service op√©rationnel
- [x] Service Notification_Service op√©rationnel
- [ ] Hook `cpfa_abonnement_validated` document√©

#### Plugin 2 : CPFA Forms & Registrations
- [ ] Formulaire Gravity Forms/Forminator cr√©√©
- [ ] Shortcode `[cpfa_abonnement_form]` fonctionnel
- [ ] Widget Elementor "CPFA Registration Form"
- [ ] Page admin "Pr√©inscriptions en attente"
- [ ] AJAX handler : valider
- [ ] AJAX handler : rejeter
- [ ] AJAX handler : demander justificatif
- [ ] Template email 1 : Pr√©inscription re√ßue
- [ ] Template email 2 : Nouvelle pr√©inscription (admin)
- [ ] Template email 3 : Abonnement valid√©
- [ ] Template email 4 : Pr√©inscription rejet√©e
- [ ] Template email 5 : Justificatif demand√©
- [ ] V√©rification doublons email
- [ ] Upload fichiers s√©curis√© (MIME type)
- [ ] Cron : expiration automatique apr√®s 7 jours

#### Plugin 3 : CPFA PDF Generator
- [ ] Template HTML carte membre (85.6 √ó 54mm)
- [ ] Hook listener : `cpfa_abonnement_validated`
- [ ] G√©n√©ration PDF avec mPDF
- [ ] Int√©gration QR code sur la carte
- [ ] Stockage dans wp-content/uploads/cpfa-pdf/
- [ ] Hook d√©clench√© : `cpfa_carte_generated`
- [ ] Gestion des erreurs (try/catch)

#### Configuration syst√®me
- [ ] Page r√©glages "Paiements" avec upload QR codes
- [ ] Page r√©glages "Notifications" avec config emails
- [ ] Page formulaire cr√©√©e et publi√©e
- [ ] R√¥le `cpfa_manager` avec capabilities
- [ ] Tests E2E complets

### B. Variables PHP importantes

```php
// Meta keys pour cpfa_abonnement
$meta_keys = [
    '_cpfa_abonnement_nom',
    '_cpfa_abonnement_prenom',
    '_cpfa_abonnement_email',
    '_cpfa_abonnement_telephone',
    '_cpfa_abonnement_type', // etudiant | professionnel | emprunt_domicile
    '_cpfa_abonnement_photo', // attachment ID
    '_cpfa_abonnement_cni', // attachment ID
    '_cpfa_abonnement_statut', // awaiting_validation | active | rejected | expired | suspended | ended
    '_cpfa_abonnement_montant', // int
    '_cpfa_abonnement_date_debut', // Y-m-d
    '_cpfa_abonnement_date_fin', // Y-m-d
    '_cpfa_abonnement_transaction_ref', // string
    '_cpfa_abonnement_gateway', // wave | orange_money
    '_cpfa_abonnement_motif_rejet', // string
    '_cpfa_abonnement_details_rejet', // string
    '_cpfa_abonnement_numero_preinscription', // PRE-20251010-00042
    '_cpfa_abonnement_numero_carte', // CPFA-2025-000042
    '_cpfa_carte_pdf', // absolute path
    '_cpfa_carte_pdf_url', // URL publique
    '_cpfa_abonnement_valide_par', // user ID
    '_cpfa_abonnement_valide_le', // mysql datetime
    '_cpfa_abonnement_rejete_par', // user ID
    '_cpfa_abonnement_rejete_le', // mysql datetime
    '_cpfa_abonnement_historique', // array serialized
];

// Options WordPress
$options = [
    'cpfa_wave_qr_url',
    'cpfa_wave_number',
    'cpfa_wave_account_name',
    'cpfa_om_qr_url',
    'cpfa_om_number',
    'cpfa_om_account_name',
    'cpfa_payment_instructions',
    'cpfa_preinscription_expire_days', // default: 7
    'cpfa_admin_email',
    'cpfa_email_from_name', // "CPFA Biblioth√®que"
    'cpfa_email_from_address', // "bibliotheque@cpfa.sn"
];
```

### C. Endpoints REST (futurs)

```php
// Soumettre une pr√©inscription via API (optionnel)
POST /wp-json/cpfa/v1/abonnements
Body: {
    "nom": "Dupont",
    "prenom": "Jean",
    "email": "jean@mail.sn",
    "telephone": "+221771234567",
    "type": "professionnel",
    "transaction_ref": "WAV-123",
    "gateway": "wave"
}

// V√©rifier le statut d'une pr√©inscription
GET /wp-json/cpfa/v1/abonnements/{id}/status
Response: {
    "statut": "awaiting_validation",
    "numero_preinscription": "PRE-20251010-00042",
    "date_soumission": "2025-10-10 14:32:00"
}

// T√©l√©charger la carte (lien s√©curis√© avec nonce)
GET /cpfa/download-carte?id={abonnement_id}&nonce={nonce}
Response: PDF file download
```

---

## R√©sum√© ex√©cutif

**Workflow en 5 √©tapes** :

1. **Utilisateur remplit le formulaire** ‚Üí Scanne QR Wave/Orange Money ‚Üí Paie via app mobile ‚Üí Soumet
2. **Syst√®me cr√©e pr√©inscription** ‚Üí Statut `awaiting_validation` ‚Üí Envoie emails (user + admin)
3. **Admin v√©rifie le paiement** ‚Üí Consulte son app Wave/Orange Money (hors WordPress)
4. **Admin valide ou rejette** ‚Üí Saisit r√©f√©rence transaction ‚Üí Valide dans WordPress
5. **Syst√®me g√©n√®re carte PDF** ‚Üí Envoie email avec carte ‚Üí Utilisateur peut utiliser biblioth√®que

**Dur√©e estim√©e du workflow** : 24-48h ouvr√©es

**Points cl√©s** :
- ‚úÖ Aucune int√©gration API automatique
- ‚úÖ Validation 100% manuelle par humain
- ‚úÖ QR codes statiques configur√©s une seule fois
- ‚úÖ Tra√ßabilit√© compl√®te de chaque action
- ‚úÖ G√©n√©ration automatique de carte apr√®s validation

**Prochaines √©tapes de d√©veloppement** :
1. D√©velopper le formulaire dans Plugin 2
2. Cr√©er l'interface admin de validation dans Plugin 2
3. Impl√©menter les templates d'emails dans Plugin 2
4. Cr√©er le template de carte membre dans Plugin 3
5. Int√©grer les 3 plugins ensemble
6. Tests E2E complets

---

**Document cr√©√© le** : 2025-10-10
**Auteur** : CPFA Development Team
**Version** : 1.0.0
**Statut** : Sp√©cifications compl√®tes - Pr√™t pour impl√©mentation
